<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Askal Thapa's Learning Journal - Reflections</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <header class="navigation"></header>

    <main class="main-container">
        <section class="reflections-container">
            <section class="reflections-header fade-in">
                <h1>üí≠ Reflections & Insights</h1>
                <p>Personal thoughts stored as JSON data and managed with Python</p>
            </section>

            <section class="stats-section fade-in" id="statsSection" style="animation-delay: 0.1s;">
                <div class="stat-item">
                    <div class="stat-number" id="totalReflections">0</div>
                    <div class="stat-label">Total Reflections</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalCategories">0</div>
                    <div class="stat-label">Categories Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="longestReflection">0</div>
                    <div class="stat-label">Longest Entry (chars)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="avgLength">0</div>
                    <div class="stat-label">Avg Entry Length</div>
                </div>
            </section>

            <section class="export-section fade-in" style="animation-delay: 0.2s;">
                <button class="refresh-btn" onclick="loadReflections()">üîÑ Refresh Data</button>
                <button class="export-btn" onclick="exportToCSV()">üì• Export to CSV</button>
            </section>

            <!-- New Add Reflection Form -->
            <section class="form-section fade-in" style="animation-delay: 0.25s;">
                <form id="reflectionForm" class="reflection-form">
                    <h3>‚ûï Add New Reflection</h3>
                    <div class="form-group">
                        <textarea id="reflectionText" placeholder="Write your reflection here..." required
                            rows="4"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <select id="reflectionCategory">
                                <option value="General">General üìù</option>
                                <option value="Learning">Learning üìö</option>
                                <option value="Insight">Insight üí°</option>
                                <option value="Challenge">Challenge ‚ö†Ô∏è</option>
                            </select>
                        </div>
                        <button type="submit" class="submit-btn">Save Entry</button>
                    </div>
                </form>
            </section>

            <section class="filter-section fade-in" id="filterSection" style="animation-delay: 0.3s;">
                <button class="filter-btn" data-category="all" onclick="filterCategory('all', this)">üìã All</button>
            </section>

            <section id="reflectionsContainer" class="reflections-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading reflections...</p>
                </div>
            </section>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Askal Thapa | Computer Science Student | UCA Farnham</p>
            <p class="footer-subtitle">Week 5: Python & JSON Backend Integration - Reflections</p>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script>
        // Global state
        let allReflections = [];
        let currentFilter = 'all';

        /**
         * Load reflections from JSON file
         */
        async function loadReflections() {
            try {
                // Fetch from the backend server explicitly
                // Using http://localhost:8000/backend/reflections.json ensures we get the file even if viewed on port 5500 or 8000
                const response = await fetch('http://localhost:8000/backend/reflections.json');
                if (!response.ok) throw new Error('Failed to fetch reflections');

                allReflections = await response.json();
                updateStats();
                renderReflections(allReflections);
                setupFilterButtons();
            } catch (error) {
                console.error('Error loading reflections:', error);
                showEmptyState('Could not load reflections. Make sure backend/reflections.json exists.');
            }
        }

        /**
         * Update statistics section
         */
        function updateStats() {
            const totalReflections = allReflections.length;
            const categories = new Set(allReflections.map(r => r.category || 'General'));
            const lengths = allReflections.map(r => (r.text || '').length);
            const longestLength = lengths.length > 0 ? Math.max(...lengths) : 0;
            const avgLength = lengths.length > 0 ? Math.round(lengths.reduce((a, b) => a + b, 0) / lengths.length) : 0;

            document.getElementById('totalReflections').textContent = totalReflections;
            document.getElementById('totalCategories').textContent = categories.size;
            document.getElementById('longestReflection').textContent = longestLength;
            document.getElementById('avgLength').textContent = avgLength;
        }

        /**
         * Setup filter buttons based on categories
         */
        function setupFilterButtons() {
            const categories = new Set(['All', ...allReflections.map(r => r.category || 'General')]);
            const filterSection = document.getElementById('filterSection');

            filterSection.innerHTML = '';

            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn' + (category === 'All' ? ' active' : '');
                btn.textContent = category === 'All' ? 'üìã All' : `${getCategoryEmoji(category)} ${category}`;
                btn.onclick = () => filterCategory(category.toLowerCase(), btn);
                filterSection.appendChild(btn);
            });
        }

        /**
         * Get emoji for category
         */
        function getCategoryEmoji(category) {
            const emojis = {
                'learning': 'üìö',
                'insight': 'üí°',
                'challenge': '‚ö†Ô∏è',
                'general': 'üìù'
            };
            return emojis[category.toLowerCase()] || 'üìå';
        }

        /**
         * Filter reflections by category
         */
        function filterCategory(category, button) {
            currentFilter = category;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');

            // Filter and render
            if (category === 'all') {
                renderReflections(allReflections);
            } else {
                const filtered = allReflections.filter(r => (r.category || 'General').toLowerCase() === category);
                renderReflections(filtered);
            }
        }

        /**
         * Render reflections to DOM
         */
        function renderReflections(reflections) {
            const container = document.getElementById('reflectionsContainer');

            if (reflections.length === 0) {
                showEmptyState('No reflections found. Add some reflections using the Python script!');
                return;
            }

            container.innerHTML = reflections
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map((reflection, index) => {
                    const category = (reflection.category || 'General').toLowerCase();
                    const date = new Date(reflection.date);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return `
                        <article class="reflection-card ${category}" style="animation-delay: ${index * 0.05}s">
                            <div class="reflection-header">
                                <div class="reflection-date">${formattedDate}</div>
                                <span class="reflection-category ${category}">${getCategoryEmoji(reflection.category)} ${reflection.category || 'General'}</span>
                            </div>
                            <div class="reflection-text">${escapeHtml(reflection.text || '')}</div>
                        </article>
                    `;
                })
                .join('');
        }

        /**
         * Show empty state message
         */
        function showEmptyState(message) {
            document.getElementById('reflectionsContainer').innerHTML = `
                <div class="empty-state">
                    <h2>üì≠ No Reflections Yet</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        /**
         * Escape HTML characters for security
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Export reflections to CSV
         */
        function exportToCSV() {
            if (allReflections.length === 0) {
                alert('No reflections to export!');
                return;
            }

            let csv = 'Date,Category,Text\n';
            allReflections.forEach(reflection => {
                const date = new Date(reflection.date).toLocaleString();
                const category = reflection.category || 'General';
                const text = (reflection.text || '').replace(/"/g, '""'); // Escape quotes
                csv += `"${date}","${category}","${text}"\n`;
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reflections-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Load reflections on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadReflections();

            // Handle Form Submission
            const form = document.getElementById('reflectionForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const text = document.getElementById('reflectionText').value;
                    const category = document.getElementById('reflectionCategory').value;

                    const newEntry = {
                        date: new Date().toISOString(),
                        text: text,
                        category: category,
                        id: Date.now()
                    };

                    // Check connectivity
                    if (navigator.onLine) {
                        try {
                            // Use absolute URL for the API to ensure we hit the Python server (port 8000)
                            // even if viewing on Live Server (port 5500)
                            const response = await fetch('http://localhost:8000/api/reflections', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newEntry)
                            });

                            if (response.ok) {
                                showNotification('Reflection saved to server! üéâ');
                                form.reset();
                                loadReflections(); // Refresh list
                            } else {
                                const errText = await response.text();
                                console.error('Server Validation Error:', errText);
                                throw new Error(`Server returned ${response.status}: ${errText}`);
                            }
                        } catch (error) {
                            console.error('Save error details:', error);
                            // Only save locally if it's a genuine network error, otherwise alerting the user is better?
                            // But for PWA resilience, we often save locally. 
                            // Let's inform the user WHY.
                            alert(`Server save failed: ${error.message}. Saving locally.`);
                            saveLocally(newEntry);
                        }
                    } else {
                        saveLocally(newEntry);
                    }
                });
            }
        });

        function saveLocally(entry) {
            // Get existing offline entries
            const offlineData = JSON.parse(localStorage.getItem('offlineReflections') || '[]');
            offlineData.push(entry);
            localStorage.setItem('offlineReflections', JSON.stringify(offlineData));

            showNotification('Saved locally! Will sync when online. üíæ');
            document.getElementById('reflectionForm').reset();

            // Optionally update UI immediately with "pending" state (optional simplification: just wait for sync)
        }
    </script>
</body>

</html>